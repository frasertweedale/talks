<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Practical PKI - ipa-external-ca</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <script src="../js/copy-button.js"></script>
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Practical PKI</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
            </div>
        </div>

        <div id="content">
            <div id="postContent">
    <h1 id="externally-signing-the-freeipa-ca">Externally signing the FreeIPA CA</h1>
<p>By default, FreeIPA installations use a <strong>self-signed CA</strong>. Many
organisations, especially large ones, require their FreeIPA CA to be
subordinated to some other CA operated by the organisation. In
other words, the CA has to be <em>externally signed</em>.</p>
<p>Because external signing does not change the Subject DN or the
signing key, a CA can change it’s chaining during its lifetime. It
can go from self-signed to externally-signed, or vice versa.</p>
<p>In this module, you will change the FreeIPA CA in your workshop
environment to be externally signed. This procedure has multiple
steps:</p>
<ol type="1">
<li>Generate a CSR.</li>
<li>Submit the CSR for signing by the external CA.</li>
<li>Install the new CSR.</li>
</ol>
<div class="note">
<p>This module must be performed on <code>ipa.$DOMAIN</code>, except where noted
below.</p>
</div>
<h2 id="initiating-renewal">Initiating renewal <a href="#initiating-renewal" class="section">§</a></h2>
<p>The <code>ipa-cacert-manage(1)</code> command renews the FreeIPA CA
certificate. To switch a self-signed installation to
externally-signed, use the <code>--external-ca</code> option:</p>
<pre class="command ipa"><code>sudo ipa-cacert-manage renew --external-ca</code></pre>
<pre class="output"><code>Exporting CA certificate signing request, please wait

The next step is to get /var/lib/ipa/ca.csr signed by your CA and
re-run ipa-cacert-manage as:

ipa-cacert-manage renew
  --external-cert-file=/path/to/signed_certificate
  --external-cert-file=/path/to/external_ca_certificate

The ipa-cacert-manage command was successful</code></pre>
<p>As suggested, a CSR is ready and waiting at <code>/var/lib/ipa/ca.csr</code>.</p>
<h2 id="signing-the-csr">Signing the CSR <a href="#signing-the-csr" class="section">§</a></h2>
<p>In real world scenarios, how to submit the CSR for signing depends
on all sorts of things: the CA implementation, organisational
policy, the phase of the moon.</p>
<p>Fortunately this is not a real world scenario, so I have provided a
fake “external CA”. With it you can simulate the experience with
much less bureaucracy.</p>
<p>The “external” CA key and certificate, and an OpenSSL config file,
are in the <code>/root/ca</code> directory. Execute the following command to
sign the CSR:</p>
<pre class="command ipa"><code>sudo openssl x509 \
    -req -in /var/lib/ipa/ca.csr \
    -CAkey /root/ca/ca.key \
    -CA /root/ca/ca.crt \
    -extfile /root/ca/ca.cnf -extensions exts \
    -days 740 \
    -out ipa-new.crt</code></pre>
<pre class="output"><code>Certificate request self-signature ok
subject=O=E1.PKI.FRASE.ID.AU, CN=Certificate Authority</code></pre>
<h2 id="completing-the-renewal">Completing the renewal <a href="#completing-the-renewal" class="section">§</a></h2>
<p>Run <code>ipa-cacert-manage renew</code> again, and point it to the issued
certificate, as well as the external issuer certificate:</p>
<pre class="command ipa"><code>sudo ipa-cacert-manage renew \
    --external-cert-file ipa-new.crt \
    --external-cert-file /root/ca/ca.crt</code></pre>
<pre class="output"><code>Importing the renewed CA certificate, please wait
CA certificate successfully renewed
The ipa-cacert-manage command was successful</code></pre>
<div class="note">
<p>When there are additional certificates in the chain, repeat the
<code>--external-cert-file</code> option for all certificates. Alternatively,
you can provide a PKCS #7 file with the complete chain.</p>
</div>
<p>We are not quite done. Certificate stores on servers and clients
still contain the original, self-signed certificate. Run
<code>ipa-certupdate</code> <strong>on all server replicas</strong> (none in our case) <strong>and
all client machines</strong> to import the new CA certificate.</p>
<pre class="command ipa"><code>sudo ipa-certupdate</code></pre>
<pre class="output"><code>Systemwide CA database updated.
Systemwide CA database updated.
The ipa-certupdate command was successful</code></pre>
<p>Use <code>ipa ca-show</code> to confirm that the FreeIPA CA certificate is
signed by the external CA:</p>
<pre class="command ipa"><code>echo Secret.123 | kinit admin</code></pre>
<pre class="command ipa"><code>ipa ca-show ipa --raw |grep dn</code></pre>
<pre class="output"><code>  ipacasubjectdn: CN=Certificate Authority,O=E1.PKI.FRASE.ID.AU
  ipacaissuerdn: O=PKI.FRASE.ID.AU,CN=PKI Workshop CA</code></pre>
<div class="note">
<p>You have completed the exercises for this module. The sections that
follow are informational.</p>
</div>
<h2 id="renewing-an-externally-signed-ca">Renewing an externally signed CA <a href="#renewing-an-externally-signed-ca" class="section">§</a></h2>
<p>Certmonger cannot automatically renew an externally-signed CA.
Administrators must anticipate and manually initiate renewal. The
procedure is the same as switching from self-signed to
externally-signed.</p>
<h2 id="installing-freeipa-with-an-externally-signed-ca">Installing FreeIPA with an externally signed CA <a href="#installing-freeipa-with-an-externally-signed-ca" class="section">§</a></h2>
<p>Installing FreeIPA with an externally signed CA is a two stage
process, similar to renewal. The <code>ipa-server-install(1)</code> command
accepts the same <code>--external-ca</code> and <code>--external-cert-file</code>
arguments as <code>ipa-cacert-manage(1)</code>.</p>
</div>
<div id="nav" class="footer">
    <div class="back">
        
        <a href="ipa-profiles.html">
            <
            <br />
            FreeIPA certificate profiles and user certificates
        </a>
        
    </div>
    <div class="up">
        
        <a href="../index.html#toc">
            ^
            <br />
            Up to index
        </a>
        
    </div>
    <div class="next">
        
    </div>
</div>

        </div>
        <div class="clear"></div>

        <div class="footer">

<div id="license">
    <div style="float: left">
        <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
            <img alt="Creative Commons License" style="border-width:0" src="https://licensebuttons.net/l/by/4.0/88x31.png">
        </a>
    </div>
    <div>
        <p>
        Except where otherwise noted, this work is licensed under a
        <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
            Creative Commons Attribution 4.0 International License</a>.
        </p>
    </div>
</div>

<div id="hakyll">
    Generated by
    <a href="https://jaspervdj.be/hakyll">Hakyll</a>
</div>

        </div>
    </body>
</html>
