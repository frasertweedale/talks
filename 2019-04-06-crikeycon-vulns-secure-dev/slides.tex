\documentclass[ignorenonframetext,aspectratio=169]{beamer}
\setbeamertemplate{caption}[numbered]
\setbeamertemplate{caption label separator}{: }
\setbeamercolor{caption name}{fg=normal text.fg}
\beamertemplatenavigationsymbolsempty
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\newif\ifbibliography
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\newenvironment{Shaded}{}{}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.56,0.13,0.00}{{#1}}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.53,0.00,0.00}{{#1}}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.73,0.40,0.53}{{#1}}}
\newcommand{\ImportTok}[1]{{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textit{{#1}}}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.73,0.13,0.13}{\textit{{#1}}}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{{#1}}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.02,0.16,0.49}{{#1}}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.10,0.09,0.49}{{#1}}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.40,0.40,0.40}{{#1}}}
\newcommand{\BuiltInTok}[1]{{#1}}
\newcommand{\ExtensionTok}[1]{{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.74,0.48,0.00}{{#1}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.49,0.56,0.16}{{#1}}}
\newcommand{\RegionMarkerTok}[1]{{#1}}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
\newcommand{\NormalTok}[1]{{#1}}

\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight0.8\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
%\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\newcommand{\includegraphicsscaled}[1]{
    \includegraphics[width=\maxwidth,height=\maxheight,keepaspectratio]{#1}
}

% Prevent slide breaks in the middle of a paragraph:
\widowpenalties 1 10000
\raggedbottom

\AtBeginPart{
  \let\insertpartnumber\relax
  \let\partname\relax
  \frame{\partpage}
}
\AtBeginSection{
  \ifbibliography
  \else
    \let\insertsectionnumber\relax
    \let\sectionname\relax
    \frame{\sectionpage}
  \fi
}
\AtBeginSubsection{
  \let\insertsubsectionnumber\relax
  \let\subsectionname\relax
  \frame{\subsectionpage}
}

\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{0}
\input{../share/unicode-decl.tex}
\usefonttheme[onlymath]{serif}
\hypersetup{breaklinks=true,colorlinks,linkcolor=,urlcolor=purple}
\setbeamertemplate{navigation symbols}{}
\setbeamercolor{footnote mark}{fg=gray}
\setbeamerfont{footnote}{size=\tiny}
\usepackage[normalem]{ulem}
\usepackage{listings}
\lstset{
    basicstyle=\ttfamily\large,
    keywordstyle=\color{blue}\bfseries,
    commentstyle=\color[rgb]{0,0.5,0}\bfseries\em
}

\newcommand\greyuline{\bgroup\markoverwith
    {\textcolor{lightgray}{\rule[-0.5ex]{2pt}{0.4pt}}}\ULon}

\title{\bf From Defect to Doctrine}
\subtitle{\bf Security bug case studies}
\author{\bf Fraser Tweedale\\
    \texttt{@hackuador}}
\date{\bf April 4, 2019}

\begin{document}

\begin{frame}
\titlepage
\end{frame}

\section{Dogtag PKI}\label{dogtag}

\begin{frame}{Access control - definition}
\begin{verbatim}
certServer.ca.authorities
  :create,modify
  :allow (list,read) user="anybody"
    ;allow (create,modify,delete) group="Administrators"
    ;deny (create,modify,delete) user="mallory"
  :Administrators may create and modify lightweight authorities
\end{verbatim}
\end{frame}

\begin{frame}{Access control - evaluation order}
\begin{verbatim}
authz.evaluateOrder=deny,allow
\end{verbatim}
\end{frame}

\begin{frame}[fragile]{Access control - processing}
\begin{lstlisting}[language=Java]
if (order.equals("deny,allow"))
    entries = getDenyEntries(acls, op);
else
    entries = getAllowEntries(acls, op);

for (ACLEntry entry : entries) {
    if (evaluate(token, entry.getExpressions()))
        throw new EACLsException("permission denied");
}

if (order.equals("deny,allow"))
    entries = getAllowEntries(acls, op);
else
    entries = getDenyEntries(acls, op);

for (ACLEntry entry : entries) {
    if (evaluate(token, entry.getExpressions()))
        result = true;
}
if (!result)
    throw new EACLsException("permission denied");

\end{lstlisting}
\end{frame}


\begin{frame}[plain]
\huge
CVE-2018-1080
\end{frame}


\begin{frame}[plain]
\huge
Principle: avoid booleans; use custom types
\end{frame}

\begin{frame}[fragile]{Access control - bools be gone!}
\begin{lstlisting}[language=Java]
public enum ACLOrder { DenyAllow , AllowDeny };
public enum ACLEntryType { Allow , Deny };
public enum ACLResult { Allowed , Denied };
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]{Access control - fixed}
\begin{lstlisting}[language=Java]
if (order == EvaluationOrder.DenyAllow) {
    checkDenyEntries(token, acls, op);  // throws
    result = checkAllowEntries(token, acls, op);
} else {
    result = checkAllowEntries(token, acls, op);
    checkDenyEntries(token, acls, op);  // throws
}
if (result != ACLResult.Allowed)
    throw new EACLsException("permission denied");
\end{lstlisting}
\end{frame}


%TODO what langs make this easy?


\section{FreeIPA}\label{freeipa}

%TODO show architecture diagram

\begin{frame}[plain]
\huge
CVE-2016-5404
\end{frame}

\begin{frame}[plain]
\huge
Principle: never cut corners on privilege separation
\end{frame}

%TODO fix

\begin{frame}[plain]
\huge
CVE-2017-2590
\end{frame}







\section{Firefox}\label{firefox}

%DEMO?

\begin{frame}{Object Identifier (OID)}
  \begin{tabular}{l l}
    2.5.4.3 & {\tt commonName} \\
    2.5.29.14 & {\tt subjectKeyIdentifier} \\
    1.2.840.113549.1.1.11 & {\tt sha256WithRSAEncryption} \\
  \end{tabular}
\end{frame}

\begin{frame}{Object Identifier (OID)}
  \Large
  1.3.6.1.4.1.311.21.8.8950086.10656446.2706058.12775672.480128.147.13466065.13029902
\end{frame}

\begin{frame}[fragile]{python-cryptography (bug)}
\begin{lstlisting}[language=Python]
buf_len = 80
buf = backend._ffi.new("char[]", buf_len)

res = backend._lib.OBJ_obj2txt(buf, buf_len, obj, 1)




backend.openssl_assert(res > 0)
return backend._ffi.buffer(buf, res)[:].decode()
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]{python-cryptography (fixed)}
\begin{lstlisting}[language=Python]
buf_len = 80
buf = backend._ffi.new("char[]", buf_len)

res = backend._lib.OBJ_obj2txt(buf, buf_len, obj, 1)
if res > buf_len - 1:  # account for terminating null byte
    buf_len = res + 1
    buf = backend._ffi.new("char[]", buf_len)
    res = backend._lib.OBJ_obj2txt(buf, buf_len, obj, 1)
backend.openssl_assert(res > 0)
return backend._ffi.buffer(buf, res)[:].decode()
\end{lstlisting}
\end{frame}

\begin{frame}{Object Identifier (OID)}
  \Large
  0.8.8950086.10656446.2706058.12775672.480128.147.13466065.130299021.3.6.1.4.1.311.21.8.8950086.10656446.2706058.12775672.480128.147.13466065.130299021.3.6.1.4.1.311.21.8.8950086.10656446.2706058.12775672.480128.147.13466065.130299021.3.6.1.4.1.311.21.8.8950086.10656446.2706058.12775672.480128.147.13466065.130299021.3.6.1.4.1.311.21.8.8950086.10656446.2706058.12775672.480128.147.13466065.130299021.3.6.1.4.1.311.21.8.8950086.10656446.2706058.12775672.480128.147.13466065.130299021.3.6.1.4.1.3
\end{frame}

\begin{frame}[plain]
\huge
CVE-2017-7792
\end{frame}

\begin{frame}[fragile]{Firefox (bug)}
\begin{lstlisting}[language=C++]
char buf[300];
unsigned int i, len = 0;
int written = 0;
bool first = true;
unsigned long val = 0;

for (i = 0; i < oid->len; ++i) {
  val = oid->data[i];
  if (first) {
    written = snprintf(&buf[len], sizeof(buf) - len, "%lu", val);
  } else {
    written = snprintf(&buf[len], sizeof(buf) - len, ".%lu", val);
  }
  len += written;
  first = false;
}
\end{lstlisting}
\end{frame}

\begin{frame}[plain]
\huge
Principle: don't rely on assumptions about input
\end{frame}

\begin{frame}[plain]
\huge
Principle: use memory-safe languages
\end{frame}






\section{An unnamed online service}\label{unnamed}

\begin{frame}[fragile]{authentication - library (v1)}
\begin{lstlisting}[language=Python]
def authenticate(user, pass):
    ... # talk to the database
    if all_good:
        return True
    else:
        raise AuthenticationError()
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]{authentication - application}
\begin{lstlisting}[language=Python]
user = request['username']
pass = request['password']

try:
    authenticate(user,pass)
except AuthenticationError:
    respond_401_unauthorized()

do_stuff()
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]{authentication - library (v2)}
\begin{lstlisting}[language=Python]
def authenticate(user, pass):
    ... # talk to the database
    if all_good:
        return True
    else:
        return False
\end{lstlisting}
\end{frame}

\begin{frame}[plain]
\huge
Principle: avoid using exceptions
\end{frame}




\section{Wrapping up}\label{wrapping-up}

\begin{frame}{things that weren't covered}
\begin{itemize}
\tightlist
\item cryptography
\item input validation {\em in general}
\item web things (XSS, CSRF, etc)
\item so much other stuff\ldots{}
\end{itemize}
\end{frame}

\begin{frame}{principles}
\begin{itemize}
\tightlist
\item avoid booleans; use custom types
\item never cut corners on privilege separation
\item don't rely on assumptions about input
\item use memory-safe languages
\item avoid using exceptions
\end{itemize}
\end{frame}




\begin{frame}[plain]
\begin{columns}

  \begin{column}{.4\textwidth}
    \begin{center}
    {
        \Large Questions?\\
        \medskip
        \includegraphicsscaled{sailor-victim.jpg}
    }
    \end{center}


  \end{column}

  \begin{column}{.6\textwidth}
    \hypersetup{urlcolor=black}

    \setlength{\parskip}{.5em}

    { \centering

    \input{cc-by-ARTIFACT.pdf_tex}
    \\
    { \scriptsize
    Except where otherwise noted this work is licensed under
    }\\
    { \footnotesize
      \textbf{\url{http://creativecommons.org/licenses/by/4.0/}}
    }

    \bigskip
    \large \tt

    \url{https://speakerdeck.com/frasertweedale}

    \href{https://twitter.com/hackuador}{@hackuador}

    }
  \end{column}

\end{columns}
\end{frame}







% BONUS SLIDES


\begin{frame}[fragile]{Access control - fixed}
\begin{lstlisting}[language=Java]
public enum ACLRuleType { Allow , Deny };
public enum ACLResult { Allowed , Denied };

List<ACLEntry> entries;
if (order == EvaluationOrder.DenyAllow) {
    entries = getDenyEntries(acls, op);
    entries.addAll(getAllowEntries(acls, op));
} else {
    entries = getAllowEntries(acls, op);
    entries.addAll(getDenyEntries(acls, op));
}

for (ACLEntry entry : entries) {
    Optional<ACLResult> result = entry.evaluate(token);
    if (result.isPresent()) return result.get();
}
return ACLResult.Denied;
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]{Access control - fixed}
\begin{lstlisting}[language=Haskell]
data ACLRuleOrder = AllowDeny | DenyAllow
data ACLRuleType = Allow | Deny deriving (Eq)
data ACLResult = Allowed | Denied

evaluateACL :: ACLRuleOrder -> Token -> Operation -> [ACLRule] -> ACLResult
evaluateACL order token op rules =
  fromMaybe Denied (getFirst (foldMap (First . evaluateRule token) orderedRules))
  where
    opRules = filter (elem op . aclRulePermissions) rules
    (allowRules, denyRules) = partition ((== Allow) . aclRuleType) opRules
    orderedRules = case order of
      DenyAllow -> denyRules <> allowRules
      AllowDeny -> allowRules <> denyRules
\end{lstlisting}
\end{frame}

\end{document}
